(()=>{let e,n,o,t,c;const r={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]};function a(){s("Connection failed. Please check your internet connection and try again.","error"),d(),l()}function i(){s("Lost connection. Attempting to reconnect...","warning"),d(),l()}function l(){const e=document.getElementById("connect"),n=document.getElementById("language"),o=document.getElementById("role");e&&(e.disabled=!1),n&&(n.disabled=!1),o&&(o.disabled=!1)}function s(e,n){const o=document.createElement("div");o.className=`message ${n}-message`,o.textContent=e;const t=document.querySelector(".container");t?t.appendChild(o):document.body.appendChild(o),setTimeout((()=>{o.remove()}),5e3)}function d(){n&&n.getTracks().forEach((e=>{e.stop(),n.removeTrack(e)})),o&&o.getTracks().forEach((e=>{e.stop(),o.removeTrack(e)})),e&&(e.close(),e=null),t&&(t.disconnect(),t=null);const r=document.getElementById("localVideo"),a=document.getElementById("remoteVideo");r&&(r.srcObject=null),a&&(a.srcObject=null),n=null,o=null,c=null,l()}window.location.pathname.includes("main.html")&&document.addEventListener("DOMContentLoaded",(()=>{const u=document.getElementById("connect"),m=document.getElementById("leave"),g=document.getElementById("video-container"),y=document.getElementById("selection-container");u&&g&&y?(console.log("Connect button found"),u.addEventListener("click",(async()=>{console.log("Connect button clicked");try{const d=document.getElementById("language")?.value,m=document.getElementById("role")?.value;if(!d||!m)return void s("Please select language and role","warning");u.disabled=!0,document.getElementById("language").disabled=!0,document.getElementById("role").disabled=!0,await async function(){try{if(console.log("Starting call process"),await async function(){try{const e={video:{width:{ideal:1280},height:{ideal:720}},audio:!0};n=await navigator.mediaDevices.getUserMedia(e);const o=document.getElementById("localVideo");return o&&(o.srcObject=n,o.classList.add("active"),s("Camera and microphone activated","success")),n}catch(e){throw console.error("Error accessing media devices:",e),s("Unable to access camera or microphone. Please check your permissions.","error"),l(),e}}(),console.log("Local stream started"),t=function(){try{console.log("Initializing socket connection");const n=io(window.location.origin,{path:"/socket.io/",transports:["polling","websocket"],secure:!0,reconnection:!0,rejectUnauthorized:!1,reconnectionAttempts:5,reconnectionDelay:1e3,timeout:2e4,forceNew:!0,extraHeaders:{"Access-Control-Allow-Origin":"*"}});return n.on("connect",(()=>{console.log("Socket connected:",n.id);const e=document.getElementById("language")?.value,o=document.getElementById("role")?.value;e&&o&&n.emit("join",{language:e,role:o})})),n.on("match",(async({offer:o,room:t})=>{if(console.log("Matched with peer, room:",t),c=t,o){const o=await async function(){try{const n=await e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});return await e.setLocalDescription(n),n}catch(e){throw console.error("Error creating offer:",e),e}}();n.emit("offer",o,t)}})),n.on("offer",(async o=>{console.log("Received offer");const t=await async function(n){try{if(!e)throw new Error("No peer connection available");await e.setRemoteDescription(new RTCSessionDescription(n));const o=await e.createAnswer();return await e.setLocalDescription(o),o}catch(e){throw console.error("Error handling offer:",e),e}}(o);n.emit("answer",t,c)})),n.on("answer",(async n=>{console.log("Received answer"),await async function(n){try{if(!e)throw new Error("No peer connection available");await e.setRemoteDescription(new RTCSessionDescription(n))}catch(e){throw console.error("Error handling answer:",e),e}}(n)})),n.on("candidate",(async n=>{console.log("Received ICE candidate"),await async function(n){try{if(!e)throw new Error("No peer connection available");await e.addIceCandidate(new RTCIceCandidate(n))}catch(e){throw console.error("Error handling ICE candidate:",e),e}}(n)})),n.on("connect_error",(e=>{console.error("Socket connection error:",e),a()})),n.on("disconnect",(()=>{console.log("Socket disconnected"),i()})),n}catch(e){return console.error("Socket initialization error:",e),a(),null}}(),!t)throw new Error("Failed to initialize socket");if(console.log("Socket initialized"),e=await async function(){try{return e=new RTCPeerConnection(r),n&&n.getTracks().forEach((o=>{e.addTrack(o,n)})),e.ontrack=e=>{const n=document.getElementById("remoteVideo");n&&e.streams[0]&&(n.srcObject=e.streams[0],o=e.streams[0],s("Connected to peer","success"))},e.onicecandidate=e=>{e.candidate&&t&&t.emit("candidate",e.candidate,c)},e.onconnectionstatechange=()=>{console.log("Connection state:",e.connectionState),"failed"===e.connectionState&&a()},e.oniceconnectionstatechange=()=>{console.log("ICE connection state:",e.iceConnectionState),"disconnected"===e.iceConnectionState&&i()},e}catch(e){return console.error("Error creating peer connection:",e),a(),null}}(),!e)throw new Error("Failed to initialize peer connection");console.log("Peer connection initialized")}catch(e){throw console.error("Error starting call:",e),a(),e}}(),y.style.display="none",g.style.display="block"}catch(e){console.error("Error in click handler:",e),a()}})),m&&m.addEventListener("click",(()=>{d(),y.style.display="block",g.style.display="none"}))):console.error("Required elements not found")}))})();